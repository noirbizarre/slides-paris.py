<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Python packaging</title>
<meta content="Présentation pour le 3e meetup Paris.py" name="description">
<meta content="Axel Haustant" name="author">
<meta content="width=792, user-scalable=no" name="viewport">
<meta content="ie=edge" http-equiv="x-ua-compatible">
<link href="css/paris.py.css" rel="stylesheet">
</head>
<body class="list">
    <header class="caption"><h1>Python packaging</h1>
    <p>Tour d'horizon en 15 minutes</p>
    </header><section class="slide cover first" id="packaging-python"><div>
<h2>Packaging Python</h2>
        <p>Par <a href="http://noirbizarre.info">Axel Haustant</a></p>
        <img src="images/python.jpg" alt="cover"><img src="images/logo-meetup.png" alt="logo meetup" class="logo-right">
</div></section><section class="shout slide" id="packaging"><div>
<h2>Packaging ?</h2>
    </div></section><section class="slide" id="pourquoi"><div>
<h2>Pourquoi ?</h2>
        <ul>
<li class="next">pour distribuer</li>
            <li class="next">pour déployer</li>
            <li class="next">pour archiver</li>
        </ul>
<blockquote class="next">
            <p>Être réutilisable</p>
        </blockquote>
    </div></section><section class="slide" id="comment"><div>
<h2>Comment ?</h2>
        <ul>
<li class="next">standard</li>
            <li class="next">multiplateformes</li>
            <li class="next">documenté</li>
            <li class="next">à moindre coût</li>
        </ul>
<blockquote class="next">
            <p>La solution: <code>setuptools</code> !</p>
        </blockquote>
    </div></section><section class="shout slide" id="les-bases"><div>
<h2>Les bases</h2>
    </div></section><section class="slide" id="setup-py"><div>
<h2>setup.py</h2>
        <pre><code class="python highlight"><span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s">'my-project'</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="s">'0.1.0'</span><span class="p">,</span>
    <span class="c"># ...</span>
<span class="p">)</span></code></pre>
        <p class="next">C'est du Python donc tout est permis !</p>
    </div></section><section class="slide" id="identification"><div>
<h2>Identification</h2>
        <ul>
<li class="next">name</li>
            <li class="next">version</li>
            <li class="next">description</li>
            <li class="next">long_description</li>
            <li class="next">url</li>
            <li class="next">classifiers</li>
            <li class="next">...</li>
        </ul>
</div></section><section class="slide" id="versionning"><div>
<h2>Versionning</h2>
        <ul>
<li class="next">
                <p>respect des normes (<a href="http://www.python.org/dev/peps/pep-0386/">PEP 386</a>, <a href="http://www.semver.org">semver</a>...)</p>
                <ul>
<li class="next">release: <code>{major}.{minor}.{patch}</code>
</li>
                    <li class="next">dev/master/...: <code>{major}.{minor}.{patch}.dev</code>
</li>
                </ul>
</li>
            <li class="next">
                <p>Automatisez la release !</p>
                <ul>
<li class="next">script shell</li>
                    <li class="next">outil dédié (ex: Zest.releaser, Bump'R, ...)</li>
                </ul>
</li>
        </ul>
</div></section><section class="slide" id="gestion-des-dependances"><div>
<h2>Gestion des dépendances</h2>
        <ul>
<li class="next">install_requires</li>
            <li class="next">tests_require</li>
            <li class="next">extras_require</li>
        </ul>
<pre><code class="python highlight next"><span class="n">extras_require</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'tests'</span><span class="p">:</span>  <span class="p">[</span><span class="s">'factory-boy'</span><span class="p">]</span>
<span class="p">}</span></code></pre>
        <pre><code class="highlight bash next"><span class="nv">$ </span>pip install my-project<span class="o">[</span>tests<span class="o">]</span></code></pre>
    </div></section><section class="slide" id="gestion-des-resources"><div>
<h2>Gestion des resources</h2>
        <ul>
<li class="next"><a href="http://pythonhosted.org/setuptools/setuptools.html#including-data-files">include_package_data/package_data</a></li>
            <li class="next"><a href="http://docs.python.org/2/distutils/sourcedist.html#the-manifest-in-template">MANIFEST.in</a></li>
            <li class="next"><a href="http://pythonhosted.org/distribute/pkg_resources.html">pkg_resouces</a></li>
        </ul>
</div></section><section class="slide" id="readme"><div>
<h2>README</h2>
        <p>Doit permettre de démarrer rapidement.</p>
        <ul>
<li class="next">Présentation fonctionnelle rapide</li>
            <li class="next">Procédure d'installation</li>
            <li class="next">Documentation (ou lien)</li>
            <li class="next">Complété par un changelog</li>
        </ul>
</div></section><section class="shout slide" id="commandes"><div>
<h2>Commandes</h2>
    </div></section><section class="slide" id="developpez"><div>
<h2>Développez</h2>
        <p>Pour être prêt à développer:</p>
        <pre><code class="highlight bash"><span class="nv">$ </span>python setup.py develop
<span class="c"># ou
</span><span class="nv">$ </span>pip install -e .</code></pre>
        <p class="next">A refaire dès que les dépendances et les entrypoints changent.</p>
    </div></section><section class="slide" id="previsualisez"><div>
<h2>Prévisualisez</h2>
        <p>Contrôlez ce que vous allez publier</p>
        <pre><code class="highlight bash"><span class="nv">$ </span>python setup.py --long-description | rst2html
<span class="nv">$ </span>python setup.py sdist</code></pre>
    </div></section><section class="slide" id="publiez"><div>
<h2>Publiez</h2>
        <pre><code class="highlight bash"><span class="c"># Enregistrer le module sur PyPI
</span><span class="nv">$ </span>python setup.py register
<span class="c"># Publier sur PyPI
</span><span class="nv">$ </span>python setup.py sdist upload
<span class="c"># Créer un version avec un suffix
</span><span class="nv">$ </span>python setup.py -q egg_info -b <span class="s2">".1234"</span> sdist</code></pre>
    </div></section><section class="shout slide" id="reutilisez"><div>
<h2>Réutilisez !</h2>
    </div></section><section class="slide" id="reutiliser-les-metadonnees-du-module"><div>
<h2>Réutiliser les metadonnées du module</h2>
        <p>Selon la <a href="http://www.python.org/dev/peps/pep-0396/">PEP 396</a>, le module doit contenir un attribut <code>__version__</code></p>
        <pre><code class="python highlight next"><span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">__version__</span><span class="p">,</span> <span class="n">__description__</span>
<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s">'project'</span>
    <span class="n">version</span><span class="o">=</span><span class="n">__version__</span>
    <span class="n">description</span><span class="o">=</span><span class="n">__description__</span>
<span class="p">)</span></code></pre>
        <footer>la PEP 396 porte uniquement sur __version__</footer>
</div></section><section class="slide" id="reutiliser-les-requirements-de-pip"><div>
<h2>Réutiliser les requirements de pip</h2>
        <pre><code class="python highlight condensed"><span class="n">RE_REQUIREMENT</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r'^\s*-r\s*(?P&lt;filename&gt;.*)$'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">pip</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">requirements</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="s">'requirements'</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">RE_REQUIREMENT</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">requirements</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pip</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">'filename'</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">requirements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">requirements</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="c"># ...</span>
    <span class="n">install_requires</span><span class="o">=</span><span class="n">pip</span><span class="p">(</span><span class="s">'install.pip'</span><span class="p">),</span>
    <span class="n">tests_require</span><span class="o">=</span><span class="n">pip</span><span class="p">(</span><span class="s">'test.pip'</span><span class="p">),</span>
    <span class="n">extras_require</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'tests'</span><span class="p">:</span>  <span class="n">pip</span><span class="p">(</span><span class="s">'test.pip'</span><span class="p">),</span>
    <span class="p">},</span>
<span class="p">)</span></code></pre>
    </div></section><section class="slide" id="reutiliser-les-fichiers-rst"><div>
<h2>Réutiliser les fichiers rst</h2>
        <pre><code class="python highlight condensed"><span class="n">PYPI_RST_FILTERS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s">r'\.\.\s? code-block::\s*(\w|\+)+'</span><span class="p">,</span>  <span class="s">'::'</span><span class="p">),</span> <span class="c">#</span>
    <span class="p">(</span><span class="s">r'.*travis-ci\.org/.*'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
    <span class="p">(</span><span class="s">r'.*pypip\.in/.*'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
    <span class="p">(</span><span class="s">r'.*crate\.io/.*'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
    <span class="p">(</span><span class="s">r'.*coveralls\.io/.*'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">rst</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">content</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">regex</span><span class="p">,</span> <span class="n">replacement</span> <span class="ow">in</span> <span class="n">PYPI_RST_FILTERS</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">replacement</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">content</span>

<span class="n">long_description</span> <span class="o">=</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="o">.</span><span class="n">join</span><span class="p">((</span>
    <span class="n">rst</span><span class="p">(</span><span class="s">'README.rst'</span><span class="p">),</span>
    <span class="n">rst</span><span class="p">(</span><span class="s">'CHANGELOG.rst'</span><span class="p">),</span>
    <span class="s">''</span>
<span class="p">))</span></code></pre>
        <footer>verifier que code-block est toujours d'actualité avec la nouvelle version de PyPI et sur Crate.io</footer>
</div></section><section class="slide" id="reutilisez-la-version"><div>
<h2>Réutilisez la version</h2>
        <pre><code class="python highlight"><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pkg_resources</span> <span class="kn">import</span> <span class="n">get_distribution</span>
    <span class="n">VERSION</span> <span class="o">=</span> <span class="n">get_distribution</span><span class="p">(</span><span class="s">'project'</span><span class="p">)</span><span class="o">.</span><span class="n">version</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">VERSION</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="s">'project'</span><span class="p">)</span><span class="o">.</span><span class="n">__version__</span></code></pre>
        <p class="next">Prend en compte la version "<strong>installée</strong>" (ex: <em>0.1.0.dev1234</em>)</p>
    </div></section><section class="shout slide" id="entry-points"><div>
<h2>Entry Points</h2>
    </div></section><section class="slide" id="console-scripts"><div>
<h2>Console scripts</h2>
        <p>Pas besoin de répertoire <code>bin</code></p>
        <pre><code class="python highlight next"><span class="n">entry_points</span><span class="o">=</span><span class="p">{</span>
    <span class="s">'console_scripts'</span><span class="p">:</span> <span class="p">[</span>
        <span class="s">'myexec = project.commands:main'</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">}</span></code></pre>
        <pre><code class="highlight bash next"><span class="nv">$ </span>myexec</code></pre>
    </div></section><section class="slide" id="creer-ses-propres-commandes"><div>
<h2>Créer ses propres commandes</h2>
        <pre><code class="python highlight condensed"><span class="n">entry_points</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'distutils.commands'</span><span class="p">:</span> <span class="s">'do_it = project.commands:DoSomething'</span><span class="p">,</span>
<span class="p">},</span></code></pre>
        <pre><code class="python highlight condensed next"><span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">Command</span>

<span class="k">class</span> <span class="nc">DoSomething</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s">"Do something"</span>
    <span class="n">user_options</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">initialize_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">finalize_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">do_something</span><span class="p">()</span></code></pre>
    </div></section><section class="slide" id="chargement-d-extensions"><div>
<h2>Chargement d'extensions</h2>
        <p>Un project qui exporte</p>
        <pre><code class="python highlight condensed next"><span class="n">entry_points</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'myproject.plugins'</span><span class="p">:</span> <span class="p">[</span>
        <span class="s">'someplugin = other_project.plugins:SomePlugin'</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">},</span></code></pre>
        <p class="next">Un autre qui importe</p>
        <pre><code class="python highlight condensed next"><span class="kn">import</span> <span class="nn">pkg_resources</span>

<span class="k">for</span> <span class="n">entrypoint</span> <span class="ow">in</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">iter_entry_points</span><span class="p">(</span><span class="s">'myproject.plugins'</span><span class="p">):</span>
    <span class="n">plugin</span> <span class="o">=</span> <span class="n">entrypoint</span><span class="o">.</span><span class="n">load</span><span class="p">()</span></code></pre>
    </div></section><section class="slide" id="un-peu-de-lecture"><div>
<h2>Un peu de lecture</h2>
        <ul>
<li><a href="https://pythonhosted.org/setuptools/">Documentation officielle de setuptools</a></li>
            <li><a href="http://guide.python-distribute.org/">The Hitchhiker's Guide to Packaging</a></li>
            <li>
<a href="http://www.python.org/dev/peps/pep-0386/">PEP 386</a> (numéro de version)</li>
            <li>
<a href="http://www.python.org/dev/peps/pep-0396/">PEP 396</a> (version d'un module)</li>
            <li>
<a href="http://www.python.org/dev/peps/pep-0345/">PEP 345</a> (métadonnées)</li>
            <li>
<a href="http://www.python.org/dev/peps/pep-0426/">PEP 426</a> (métadonnées 2.0)</li>
            <li><a href="http://www.semver.org">semver</a></li>
        </ul>
</div></section><section class="shout slide" id="questions"><div>
<h2>Questions</h2>
    </div></section><section class="slide" id="a-suivre"><div>
<h2>A suivre...</h2>
        <ul>
<li>
                <p>présentation:</p>
                <ul>
<li><a href="http://noirbizarre.github.io/slides/paris.py/">http://noirbizarre.github.io/slides/paris.py/</a></li>
                    <li><a href="http://slides.noirbizarre.info/paris.py/">http://slides.noirbizarre.info/paris.py/</a></li>
                </ul>
</li>
            <li>blog: <a href="http://noirbizarre.info">http://noirbizarre.info</a>
</li>
            <li>twitter: <a href="https://twitter.com/noirbizarre">@noirbizarre</a>
</li>
            <li>google+: <a href="https://plus.google.com/118323681296003594129/">noirbizarre</a>
</li>
        </ul>
</div></section><section class="shout slide" id="extras"><div>
<h2>Extras</h2>
    </div></section><section class="slide" id="layout"><div>
<h2>Layout</h2>
        <pre><code class="highlight condensed">├── doc
├── myproject
│   ├─ __init__.py
│   └─ ..
├── requirements
│   ├─ develop.pip
│   ├─ install.pip
│   ├─ tools.pip
│   └─ test.pip
├─ .gitignore
├─ Makefile/Fabfile
├─ bumpr.rc
├─ CHANGELOG.rst
├─ pep8.rc
├─ pylint.rc
├─ MANIFEST.in
├─ README.rst
└─ setup.py</code></pre>
    </div></section><div class="progress"><div></div></div>
<script src="js/paris.py.js"></script>
</body>
</html>
